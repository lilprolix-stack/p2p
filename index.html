<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glass LAN Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .message-in { align-self: flex-start; background: rgba(255,255,255,0.2); }
        .message-out { align-self: flex-end; background: rgba(99, 102, 241, 0.4); }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="glass w-full max-w-6xl h-[85vh] rounded-3xl overflow-hidden flex">
        <!-- Sidebar -->
        <div class="w-1/4 border-r border-white/10 flex flex-col">
            <div class="p-6">
                <h1 class="text-white text-xl font-bold flex items-center gap-2">
                    <i data-lucide="zap" class="text-yellow-400"></i> LAN Chat
                </h1>
            </div>
            <div id="userList" class="flex-1 overflow-y-auto p-4 space-y-2">
                <!-- Сюда будут добавляться устройства -->
                <div class="text-white/50 text-sm text-center mt-10">Поиск устройств в сети...</div>
            </div>
            <div class="p-4 border-t border-white/10">
                <button onclick="clearAllHistory()" class="text-xs text-white/40 hover:text-red-400 transition flex items-center gap-1">
                    <i data-lucide="trash-2" class="w-3"></i> Очистить всю историю
                </button>
            </div>
        </div>

        <!-- Chat Area -->
        <div id="chatPlaceholder" class="flex-1 flex flex-col items-center justify-center text-white/50">
            <i data-lucide="message-square" class="w-16 h-16 mb-4 opacity-20"></i>
            <p>Выберите устройство для начала общения</p>
        </div>

        <div id="chatWindow" class="hidden flex-1 flex flex-col">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <div>
                    <h2 id="activeUserName" class="text-white font-medium text-lg">Устройство</h2>
                    <span class="text-green-400 text-xs flex items-center gap-1">
                        <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> Direct P2P Connected
                    </span>
                </div>
                <button onclick="deleteChatWithActiveUser()" class="p-2 hover:bg-white/10 rounded-full text-white/60">
                    <i data-lucide="user-minus"></i>
                </button>
            </div>

            <div id="messages" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4">
                <!-- Сообщения -->
            </div>

            <div class="p-6 bg-white/5">
                <div class="flex gap-2">
                    <label class="glass p-3 rounded-xl cursor-pointer hover:bg-white/20 transition">
                        <i data-lucide="paperclip" class="text-white"></i>
                        <input type="file" id="fileInput" class="hidden" onchange="sendFile()">
                    </label>
                    <input type="text" id="msgInput" placeholder="Напишите что-нибудь..." 
                           class="flex-1 bg-white/10 border border-white/20 rounded-xl px-4 text-white focus:outline-none focus:ring-2 ring-indigo-500/50">
                    <button onclick="sendMessage()" class="bg-indigo-500 hover:bg-indigo-600 p-3 rounded-xl text-white transition">
                        <i data-lucide="send"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Инициализация иконок
        lucide.createIcons();

        const WORKER_URL = 'wss://twilight-mouse-a26f.lil-pro-lix.workers.dev/'; // ЗАМЕНИТЕ НА ВАШ
        const myId = Math.random().toString(36).substr(2, 9);
        let ws;
        let activePeerId = null;
        let connections = {}; // P2P соединения {peerId: { pc, dc }}
        let history = JSON.parse(localStorage.getItem('chatHistory') || '{}');

        // Подключение к Cloudflare Worker (сигналинг)
        function initConnection() {
            ws = new WebSocket(WORKER_URL);
            
            ws.onopen = () => {
                // Объявляем о себе в сети
                sendSignal({ type: 'join', id: myId });
            };

            ws.onmessage = async (e) => {
                const data = JSON.parse(e.data);
                if (data.id === myId) return;

                switch(data.type) {
                    case 'join':
                        sendSignal({ type: 'presence', id: myId });
                        setupP2P(data.id, true);
                        break;
                    case 'presence':
                        setupP2P(data.id, false);
                        break;
                    case 'signal':
                        handleSignal(data);
                        break;
                }
            };
        }

        function sendSignal(data) {
            ws.send(JSON.stringify(data));
        }

        // WebRTC логика
        function setupP2P(peerId, isOfferer) {
            if (connections[peerId]) return;

            const pc = new RTCPeerConnection({
                iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
            });

            const dc = isOfferer 
                ? pc.createDataChannel("chat") 
                : null;

            connections[peerId] = { pc, dc };

            if (dc) setupDataChannel(peerId, dc);

            pc.ondatachannel = (event) => {
                connections[peerId].dc = event.channel;
                setupDataChannel(peerId, event.channel);
            };

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    sendSignal({ type: 'signal', to: peerId, from: myId, candidate: event.candidate });
                }
            };

            if (isOfferer) {
                pc.createOffer().then(offer => {
                    pc.setLocalDescription(offer);
                    sendSignal({ type: 'signal', to: peerId, from: myId, offer });
                });
            }

            updateUserList();
        }

        async function handleSignal(data) {
            if (data.to !== myId) return;
            const peer = connections[data.from];
            if (!peer) return;

            if (data.offer) {
                await peer.pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peer.pc.createAnswer();
                await peer.pc.setLocalDescription(answer);
                sendSignal({ type: 'signal', to: data.from, from: myId, answer });
            } else if (data.answer) {
                await peer.pc.setRemoteDescription(new RTCSessionDescription(data.answer));
            } else if (data.candidate) {
                await peer.pc.addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        }

        function setupDataChannel(peerId, dc) {
            dc.onopen = () => updateUserList();
            dc.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'delete-msg') {
                    deleteLocalMessage(peerId, data.msgId);
                } else if (data.type === 'delete-all') {
                    history[peerId] = [];
                    saveAndRender();
                } else {
                    addMessageToHistory(peerId, data, 'in');
                }
            };
        }

        // UI Логика
        function updateUserList() {
            const list = document.getElementById('userList');
            list.innerHTML = '';
            Object.keys(connections).forEach(id => {
                const btn = document.createElement('div');
                btn.className = `p-4 rounded-xl cursor-pointer transition ${activePeerId === id ? 'bg-white/20' : 'hover:bg-white/5'} text-white flex items-center gap-3`;
                btn.onclick = () => openChat(id);
                btn.innerHTML = `<div class="w-10 h-10 bg-gradient-to-br from-indigo-400 to-purple-500 rounded-full flex items-center justify-center font-bold">${id.substr(0,2).toUpperCase()}</div>
                                 <div><div class="text-sm font-medium">Device ${id.substr(0,4)}</div><div class="text-xs text-green-400">Online</div></div>`;
                list.appendChild(btn);
            });
        }

        function openChat(id) {
            activePeerId = id;
            document.getElementById('chatPlaceholder').classList.add('hidden');
            document.getElementById('chatWindow').classList.remove('hidden');
            document.getElementById('activeUserName').innerText = `Device ${id}`;
            updateUserList();
            renderMessages();
        }

        function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text || !activePeerId) return;

            const msg = { id: Date.now(), text, type: 'text' };
            connections[activePeerId].dc.send(JSON.stringify(msg));
            addMessageToHistory(activePeerId, msg, 'out');
            input.value = '';
        }

        function addMessageToHistory(peerId, msg, direction) {
            if (!history[peerId]) history[peerId] = [];
            history[peerId].push({ ...msg, direction });
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('chatHistory', JSON.stringify(history));
            renderMessages();
        }

        function renderMessages() {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            if (!history[activePeerId]) return;

            history[activePeerId].forEach(msg => {
                const div = document.createElement('div');
                div.className = `max-w-[70%] p-3 rounded-2xl text-white relative group ${msg.direction === 'out' ? 'message-out' : 'message-in'}`;
                div.innerHTML = `
                    ${msg.text}
                    <button onclick="requestDelete('${msg.id}')" class="absolute -left-8 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition text-red-400">
                        <i data-lucide="x-circle" class="w-4"></i>
                    </button>
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        function requestDelete(msgId) {
            // Удалить у себя
            deleteLocalMessage(activePeerId, msgId);
            // Отправить запрос на удаление у собеседника
            connections[activePeerId].dc.send(JSON.stringify({ type: 'delete-msg', msgId }));
        }

        function deleteLocalMessage(peerId, msgId) {
            history[peerId] = history[peerId].filter(m => m.id != msgId);
            saveAndRender();
        }

        function deleteChatWithActiveUser() {
            if (confirm('Удалить историю у обоих?')) {
                connections[activePeerId].dc.send(JSON.stringify({ type: 'delete-all' }));
                history[activePeerId] = [];
                saveAndRender();
            }
        }

        function clearAllHistory() {
            if (confirm('Очистить ВООБЩЕ всё?')) {
                localStorage.clear();
                history = {};
                renderMessages();
            }
        }

        initConnection();
    </script>
</body>
</html>
